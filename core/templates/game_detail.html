{% extends "base.html" %}

{% block title %}{{ game }} | Pokerdex{% endblock %}

{% block content %}
{% if from_group %}
{% url 'core:group_detail' slug=from_group.slug as group_url %}
{% include "includes/back_to_link.html" with href=group_url label="Voltar ao grupo" icon="bi-arrow-left-circle" %}
{% endif %}

<div class="card bg-dark border-secondary text-light mb-3">
  <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
    <div class="flex-grow-1">
      <h1 class="h4 text-warning mb-2">{{ game }}</h1>

      <div class="d-flex flex-wrap gap-2">
        <span class="chip chip-neutral" title="Data">üìÖ {{ game.date|date:"d/m/Y" }}</span>
        {% if game.location %}
          <span class="chip chip-neutral" title="Local">üìç {{ game.location }}</span>
        {% endif %}
        <span class="chip chip-gold" title="Buy-in">üí∞ R$ {{ game.buy_in }}</span>
        <span class="chip chip-green" title="Total da noite">üíµ R$ {{ total_pot }}</span>

      </div>
    </div>
    {% if can_edit_game %}
      <a class="btn btn-sm btn-outline-primary" href="{% url 'core:game_edit' pk=game.pk %}">Editar partida</a>
      <form class="d-inline" method="post" action="{% url 'core:game_delete' pk=game.pk %}">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
      </form>
    {% endif %}
    {% if participations %}
      <div class="ms-md-auto d-flex gap-2">
        <a href="{% url 'core:participation_add' game.pk %}" class="btn btn-sm btn-outline-warning">
          + Adicionar participa√ß√£o
        </a>
      </div>
    {% endif %}
  </div>
</div>

{% if not participations %}
  <div class="text-center my-4">
    <p class="mb-3">Nenhuma participa√ß√£o ainda.</p>
    <a href="{% url 'core:participation_add' game.pk %}" class="btn btn-warning">
      + Adicionar participa√ß√£o
    </a>
  </div>
{% endif %}

{% if participations %}
<div class="card bg-dark border-secondary text-light card-hover">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 m-0">Participa√ß√µes</h2>
      <span class="badge bg-secondary">{{ participations|length }}</span>
    </div>

<ul class="list-group list-group-flush">
  {% for p in participations %}
    {% with invested=game.buy_in|add:p.rebuy %}
      <li class="list-group-item text-light d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span class="player-pill">{{ p.player }}</span>
        </div>

        <div class="text-end">
          <div class="d-flex align-items-center gap-2 justify-content-end">
            {% if can_edit_game or request.user.id == p.player_id %}
              <a class="btn btn-xs btn-outline-primary" href="{% url 'core:participation_edit' pk=game.pk part_id=p.pk %}">Editar</a>
              <form class="d-inline" method="post" action="{% url 'core:participation_delete' pk=game.pk part_id=p.pk %}">
                {% csrf_token %}
                <button class="btn btn-xs btn-outline-danger" type="submit">Excluir</button>
              </form>
            {% endif %}
            <div class="amount
                {% if p.final_balance > invested %}
                  amount-win
                {% elif p.final_balance < invested %}
                  amount-loss
                {% else %}
                  amount-even
                {% endif %}">
              R$ {{ p.final_balance }}
            </div>

            <span class="chip chip-neutral" title="Rebuy">
              ‚Üª R$ {{ p.rebuy|default:0 }}
            </span>
          </div>
        </div>
      </li>
    {% endwith %}
  {% endfor %}
</ul>

    </div>
  </div>
{% endif %}
{% endblock %}
