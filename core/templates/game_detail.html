{% extends "base.html" %}

{% block title %}{{ game }} | Pokerdex{% endblock %}

{% block content %}
{% if from_group %}
{% url 'core:group_detail' slug=from_group.slug as group_url %}
{% include "includes/back_to_link.html" with href=group_url label="Voltar ao grupo" icon="bi-chevron-left" %}
{% endif %}

<div class="card bg-dark border-secondary text-light mb-3">
  <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
    <div class="flex-grow-1">
      <h1 class="h4 text-warning mb-2">{{ game }}</h1>

      <div class="d-flex flex-wrap gap-2">
        <span class="chip chip-neutral" title="Data">📅 {{ game.date|date:"d/m/Y" }}</span>
        {% if game.location %}
          <span class="chip chip-neutral" title="Local">📍 {{ game.location }}</span>
        {% endif %}
        <span class="chip chip-gold" title="Buy-in">💰 R$ {{ game.buy_in }}</span>
        <span class="chip chip-green" title="Total da noite">💵 R$ {{ total_pot }}</span>

      </div>
    </div>
    {% if can_edit_game %}
      <a class="btn btn-sm btn-glass btn-glass-gold btn-icon-gap d-md-label" href="{% url 'core:game_edit' pk=game.pk %}"><i class="bi bi-pencil-fill"></i>Editar</a>
      <form class="d-inline" method="post" action="{% url 'core:game_delete' pk=game.pk %}">
        {% csrf_token %}
        <button class="btn btn-sm btn-glass btn-glass-danger btn-icon-gap d-md-label" type="submit"><i class="bi bi-trash3-fill"></i> Excluir</button>
      </form>
    {% endif %}
    {% if participations %}
      <div class="ms-md-auto d-flex gap-2">
        <a href="{% url 'core:participation_add' game.pk %}" class="btn btn-sm btn-glass btn-glass-green btn-icon-gap d-md-label">
          <i class="bi bi-person-fill-add"></i>
          Adicionar participante
        </a>
      </div>
    {% endif %}
  </div>
</div>

{% if not participations %}
  <div class="text-center my-4">
    <p class="mb-3">Nenhuma participação ainda.</p>
    <a href="{% url 'core:participation_add' game.pk %}" class="btn btn-warning">
      + Adicionar participação
    </a>
  </div>
{% endif %}

{% if participations %}
<div class="card bg-dark border-secondary text-light">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 m-0">Participações</h2>
      <span class="badge bg-secondary">{{ participations|length }}</span>
    </div>

<ul class="list-group list-group-flush">
  {% for p in participations %}
    {% with invested=game.buy_in|add:p.rebuy %}
      <li class="list-group-item text-light d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span class="player-pill">{{ p.player }}</span>
        </div>

        <div class="text-end">
          <div class="d-flex align-items-center gap-2 justify-content-end">
            <div class="amount
            {% if p.final_balance > invested %}
            amount-win
            {% elif p.final_balance < invested %}
            amount-loss
            {% else %}
            amount-even
            {% endif %}">
            R$ {{ p.final_balance }}
          </div>
          
          <span class="chip chip-neutral" title="Rebuy">
            ↻ R$ {{ p.rebuy|default:0 }}
          </span>
          {% if can_edit_game or request.user.id == p.player_id %}
            <a class="btn btn-xs btn-promote" href="{% url 'core:participation_edit' pk=game.pk part_id=p.pk %}"><i class="bi bi-pencil-fill"></i></a>
            <form class="d-inline" method="post" action="{% url 'core:participation_delete' pk=game.pk part_id=p.pk %}">
              {% csrf_token %}
              <button class="btn btn-xs btn-remove" type="submit"><i class="bi bi-trash3-fill"></i></button>
            </form>
          {% endif %}
          </div>
        </div>
      </li>
    {% endwith %}
  {% endfor %}
</ul>

    </div>
  </div>
{% endif %}
{% endblock %}
